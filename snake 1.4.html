<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SNAKE 1.4 | –§–∏–∫—Å –ù–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –ö–æ–Ω—Ç–µ–Ω—Ç–∞</title>
    
    <style>
        /* CSS –°—Ç–∏–ª–∏ V1.4 (–£–º–µ–Ω—å—à–µ–Ω–∏–µ –º–µ–Ω—é) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #A50000, #FF4500);
            color: #ecf0f1;
            margin: 0;
            padding: 0;
            min-height: 100vh; 
            transition: background 0.3s; 
        }

        /* --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ----------------------------------- */
        #main-menu-content {
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; 
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #A50000, #FF4500);
            z-index: 999; 
        }
        #main-menu-content.active {
            display: flex;
        }

        #menu-title {
            font-size: 4em; 
            font-weight: bold;
            margin-bottom: 70px; 
            color: white;
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.6);
            letter-spacing: 5px;
        }

        /* --- –ù–û–í–ê–Ø –°–ï–¢–ö–ê –î–õ–Ø –ö–ù–û–ü–û–ö –ú–ï–ù–Æ --- */
        .menu-grid {
            display: grid;
            grid-template-areas: 
                ". play ."
                "achievements shop stats"
                "achievements inventory stats"
                "achievements cases stats";
            grid-template-columns: 200px 200px 200px; 
            grid-template-rows: 70px repeat(3, 60px); 
            gap: 10px 20px;
            justify-items: center;
            align-items: center;
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–û–ö –ú–ï–ù–Æ */
        .menu-button {
            width: 180px; 
            height: 50px;
            border: 2px solid #333;
            border-radius: 5px;
            background-color: #f1c40f; 
            color: #333;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.6);
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.2s;
        }
        .menu-button:hover {
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.6);
            transform: translate(3px, 3px);
            background-color: #ffcc00;
        }

        /* –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∑–æ–Ω–∞–º —Å–µ—Ç–∫–∏ */
        #btn-play { grid-area: play; width: 200px; height: 60px; background-color: #2ecc71; color: white; margin-bottom: 10px;} 
        #btn-play:hover { background-color: #27ae60; }
        
        /* –ë–æ–∫–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –Ω–∞ 3 —Ä—è–¥–∞ */
        #btn-achievements { grid-area: achievements; height: 190px; }
        #btn-stats { grid-area: stats; height: 190px; }
        
        #btn-shop { grid-area: shop; }
        #btn-inventory { grid-area: inventory; }
        #btn-cases { grid-area: cases; }


        /* --- –ú–ï–ù–Æ –°–õ–û–ñ–ù–û–°–¢–ò/–†–ï–ñ–ò–ú–ê (–£–ú–ï–ù–¨–®–ï–ù–û) --- */
        #difficulty-menu-content {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.95); 
            z-index: 1001;
            padding: 20px;
            overflow: auto;
        }
        #difficulty-menu-content.active {
            display: flex;
        }

        #difficulty-menu-content h3 {
             margin-top: 20px;
             margin-bottom: 10px;
        }
        
        /* –ì–†–£–ü–ü–´ –ö–ù–û–ü–û–ö */
        .difficulty-options, .map-options, .event-options {
            display: flex;
            flex-wrap: wrap; 
            gap: 10px; 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 1px solid #7f8c8d;
            border-radius: 8px;
            justify-content: center;
            max-width: 600px; 
        }
        .difficulty-options button, .map-options button, .event-options button {
             width: 150px; 
             height: 35px;
             background-color: #34495e;
             color: white;
             border: 2px solid transparent;
             cursor: pointer;
             transition: all 0.2s;
        }
        .difficulty-options button.selected, .map-options button.selected, .event-options button.selected {
            border-color: #f1c40f;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.8);
            transform: scale(1.05);
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –°–æ–±—ã—Ç–∏—è "–õ–æ–≥–æ–≤–æ –û—Ä–∫–∞" */
        #map-orc-den {
            background-color: #c0392b !important;
            border-color: #f1c40f !important;
            box-shadow: 0 0 15px #FF0000 !important;
            font-weight: bold;
        }

        /* --- –ë–£–°–¢–´ –ù–ê–ß–ê–õ–ê –ò–ì–†–´ --- */
        #booster-selection {
            margin-top: 15px; 
            padding: 15px; 
            border: 2px solid #2ecc71;
            border-radius: 8px;
            width: 90%;
            max-width: 500px; 
            background-color: #2c3e50;
        }
        .booster-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px; 
            margin-bottom: 3px;
            background-color: #34495e;
            border-radius: 4px;
        }
        .booster-item button {
            background-color: #f1c40f;
            color: #333;
            width: 70px;
            height: 25px;
            border: none;
            cursor: pointer;
        }
        .booster-item button.active {
            background-color: #2ecc71;
            color: white;
        }

        #btn-start-game {
            margin-top: 20px; 
            width: 200px;
            height: 50px;
            font-size: 1.3em;
            background-color: #2ecc71;
            color: white;
        }
        #btn-start-game:hover {
            background-color: #27ae60;
        }


        /* --- UI –í–ï–†–•–ù–ò–ô –ü–ê–ù–ï–õ–¨ –î–õ–Ø –í–ö–õ–ê–î–û–ö --- */
        #header-bar {
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 20px;
            background-color: #34495e;
            display: none; 
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #progression-display { 
            display: flex; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é flex, –Ω–æ –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç –≤ game-content */
            align-items: center; 
            font-size: 1.2em; 
        }
        
        .currency-item { display: flex; align-items: center; margin-left: 15px; padding: 5px 10px; background-color: #2c3e50; border-radius: 5px; border: 1px solid #7f8c8d; }
        .currency-item span { margin-left: 5px; font-weight: bold; }
        .coin-icon { color: gold; margin-right: 5px; }
        .score-icon { color: #f39c12; margin-right: 5px; }

        .back-button { 
            background-color: #c0392b; 
            color: white; 
            font-weight: bold;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* --- –û–ë–©–ò–ô –ö–û–ù–¢–ï–ù–¢ –í–ö–õ–ê–î–û–ö --------------------------------------- */
        .tab-content { 
            display: none; 
            padding-top: 80px; 
            padding-bottom: 50px; 
            width: 90%; 
            max-width: 1000px; 
            margin-left: auto; 
            margin-right: auto; 
            background-color: transparent; 
            min-height: auto; 
            position: relative; 
        }
        .tab-content.active { 
            display: block; 
            z-index: 500;
        }
        .tab-content h2 { margin-top: 0; padding-top: 20px; }

        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
        #game-content { min-height: 100vh; } 
        #gameCanvas { border: 5px solid #2980b9; display: block; margin: 20px auto; background-color: #111; }
        
        /* --- GAME UI ELEMENTS (New in 1.4) --- */
        #game-overlay {
            position: absolute;
            top: 20px; 
            left: 50%;
            transform: translateX(-50%);
            width: 500px;
            display: flex;
            justify-content: space-between;
            pointer-events: none; 
        }
        .buff-timer {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 1.1em;
            color: #f1c40f;
            min-width: 150px;
            text-align: center;
        }
        
        /* --- –°–¢–ò–õ–ò –ú–ê–ì–ê–ó–ò–ù–ê --- */
        
        #skins-list, #inventory-skins-list, #trail-effects-list, #inventory-trails-list { 
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; 
            margin-top: 20px;
        }
        .skin-item, .trail-item { 
            width: 160px; padding: 15px 10px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); transition: transform 0.2s; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            background-color: #34495e;
        }
        .skin-item button, .trail-item button { 
             margin-top: 5px; 
             background-color: #f1c40f; 
             color: #333; 
             font-weight: bold;
             padding: 5px 10px;
             border: none;
             border-radius: 3px;
             cursor: pointer;
        }
        
        /* –¶–≤–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–µ–π */
        .rarity-common { color: #9E9E9E; } .rarity-rare { color: #f39c12; } .rarity-epic { color: #9b59b6; } 
        .rarity-legendary { color: #FFD700; } .rarity-mythical { color: #c0392b; }
        
        /* --- –°–¢–ò–õ–ò –ö–ï–ô–°–û–í –ò –ü–†–û–ß–ï–ï --- */
        
        #case-result-wrapper { position: relative; width: 700px; height: 120px; margin: 30px auto; border: 3px solid #7f8c8d; overflow: hidden; }
        #skin-roll { display: flex; position: absolute; left: 0; top: 0; transition: transform 5s cubic-bezier(0.2, 0.9, 0.3, 1); }
        .roll-item { min-width: 100px; height: 120px; line-height: 120px; border-right: 1px solid rgba(0, 0, 0, 0.2); box-sizing: border-box; font-size: 0.8em; text-align: center; padding: 5px; cursor: default; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .stat-item { background-color: #2c3e50; padding: 20px; border-radius: 8px; }

        .achievement-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 30px; }
        .achievement-item { width: 200px; padding: 15px; border-radius: 8px; background-color: #2c3e50; border: 2px solid transparent; }
        .achievement-item.unlocked { border-color: #f1c40f; box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Å–ª–µ–¥–æ–≤ --- */
        .trail-item { 
            background-color: #34495e;
        }
        .trail-preview {
            height: 50px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        
        .equipped-status {
             background-color: #2ecc71;
             color: white;
             padding: 5px;
             border-radius: 3px;
             font-weight: bold;
             margin-top: 5px;
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ --- */
        #admin-panel {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1002;
        }
        #admin-panel.active {
            display: flex;
        }
        #admin-input {
            padding: 10px;
            margin-bottom: 15px;
            width: 300px;
            font-size: 1.1em;
            text-align: center;
            border-radius: 5px;
            border: 2px solid #3498db;
        }
        #admin-panel button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
        }
        #admin-panel button:hover {
            background-color: #2980b9;
        }

    </style>
</head>
<body>
    
    <div id="header-bar">
        <button class="back-button" onclick="showTab('main-menu-content')">‚Üê –ú–µ–Ω—é</button>
        
        <div id="progression-display">
            <div class="currency-item">
                <span class="score-icon">‚òÖ</span>
                <span id="score">0</span>
            </div>
            <div class="currency-item">
                <span class="coin-icon">üí∞</span>
                <span id="coins">0</span>
            </div>
            <button onclick="convertScoreToCoins()" style="background-color: #2ecc71; margin-left: 10px;">–û–±–º–µ–Ω (3:1)</button>
        </div>
        
        <button onclick="saveProgress(true)" style="background-color: #f39c12;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    
    
    <div id="main-menu-content" class="tab-content active">
        <div id="menu-title">SNAKE 1.4</div>
        <div class="menu-grid">
            
            <div id="btn-play" class="menu-button" onclick="showTab('difficulty-menu-content')">‚ñ∂Ô∏è –ò–ì–†–ê–¢–¨</div> 
            
            <div id="btn-achievements" class="menu-button" onclick="showTab('achievements-content')">üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</div>
            <div id="btn-stats" class="menu-button" onclick="showTab('stats-content')">üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>
            
            <div id="btn-shop" class="menu-button" onclick="showTab('shop-content')">üõí –ú–ê–ì–ê–ó–ò–ù</div>
            <div id="btn-inventory" class="menu-button" onclick="showTab('inventory-content')">üì¶ –ò–ù–í–ï–ù–¢–ê–†–¨</div>
            <div id="btn-cases" class="menu-button" onclick="showTab('cases-content')">üîë –ö–ï–ô–°–´ (<span id="cases-count">0</span>)</div>
        </div>
    </div>
    
    <div id="difficulty-menu-content" class="tab-content">
        <div id="menu-title" style="font-size: 2.5em; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –†–µ–∂–∏–º</div>
        
        <h3>1. –°–ª–æ–∂–Ω–æ—Å—Ç—å (–°–∫–æ—Ä–æ—Å—Ç—å)</h3>
        <div class="difficulty-options">
            <button id="speed-150" onclick="selectDifficulty(150, this)" style="background-color: #2ecc71;">üê¢ –õ–µ–≥–∫–æ (150ms)</button>
            <button id="speed-100" onclick="selectDifficulty(100, this)" style="background-color: #3498db;" class="selected">üö∂ –ù–æ—Ä–º–∞–ª—å–Ω–æ (100ms)</button>
            <button id="speed-50" onclick="selectDifficulty(50, this)" style="background-color: #e74c3c;">‚ö°Ô∏è –°–ª–æ–∂–Ω–æ (50ms)</button>
        </div>
        
        <h3>2. –†–µ–∂–∏–º –ö–∞—Ä—Ç—ã</h3>
        <div class="map-options">
            <button id="map-classic" onclick="selectMapMode('classic', this)" class="selected">üó∫Ô∏è –ö–ª–∞—Å—Å–∏–∫–∞</button>
            <button id="map-walls" onclick="selectMapMode('walls', this)">üß± –°—Ç–µ–Ω—ã</button>
            <button id="map-portal" onclick="selectMapMode('portal', this)">üåÄ –ü–æ—Ä—Ç–∞–ª—ã</button>
            <button id="map-narrowing" onclick="selectMapMode('narrowing', this)">‚¨áÔ∏è –°—É–∂–µ–Ω–∏–µ (V1.4)</button>
        </div>

        <h3>3. –í—Ä–µ–º–µ–Ω–Ω–æ–µ –°–æ–±—ã—Ç–∏–µ</h3>
        <div class="event-options">
             <button id="map-orc-den" onclick="selectMapMode('orc-den', this)">üî• –õ–æ–≥–æ–≤–æ –û—Ä–∫–∞ (100 –æ—á–∫–æ–≤)</button>
        </div>

        <div id="booster-selection">
            <h4>üöÄ –ë—É—Å—Ç–µ—Ä—ã (–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–π)</h4>
            <div id="active-boosters-list">
                <p style="margin-top: 5px;">–ë—É—Å—Ç–µ—Ä—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã. –í—ã–±–µ—Ä–∏—Ç–µ –≤ –ò–Ω–≤–µ–Ω—Ç–∞—Ä–µ.</p>
            </div>
            <p style="font-size: 0.9em; margin-top: 10px;">–ë—É—Å—Ç–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Ç–æ–ª—å–∫–æ –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∂–∏–º–∞—Ö.</p>
        </div>

        <button id="btn-start-game" onclick="startGame()">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
        <button class="back-button" onclick="showTab('main-menu-content')" style="margin-top: 20px;">‚Üê –ù–∞–∑–∞–¥</button>
    </div>


    <div id="game-content" class="tab-content">
        <h2>–¢–µ–∫—É—â–∏–π —Å–∫–∏–Ω: <span id="current-skin-name">–ó–µ–ª–µ–Ω—ã–π</span> | –°–ª–µ–¥: <span id="current-trail-name">–ù–µ—Ç</span></h2>
        
        <div id="game-overlay">
            <div id="buff-timer-double" class="buff-timer" style="display:none; color: gold;">üöÄ x2 –û–ß–ö–û–í: <span id="double-timer-value"></span></div>
            <div id="buff-timer-slow" class="buff-timer" style="display:none; color: #1ABC9C;">üê¢ –ó–ê–ú–ï–î–õ–ï–ù–ò–ï: <span id="slow-timer-value"></span></div>
            <div id="buff-timer-reverse" class="buff-timer" style="display:none; color: #8A2BE2;">‚ö†Ô∏è –†–ï–í–ï–†–°: <span id="reverse-timer-value"></span></div>
            <div id="orc-den-status" class="buff-timer" style="display:none; color: #c0392b;">üî• –û–†–ö: <span id="orc-den-status-value"></span></div>
            <div id="narrowing-timer" class="buff-timer" style="display:none; color: #E74C3C;">‚¨áÔ∏è –°–£–ñ–ï–ù–ò–ï: <span id="narrowing-timer-value"></span></div>
        </div>

        <canvas id="gameCanvas" width="500" height="500"></canvas>
        <p id="game-message" style="color: yellow; font-size: 1.5em;"></p>
        <p id="game-info">–ù–∞–∂–º–∏—Ç–µ **–ü–†–û–ë–ï–õ** –¥–ª—è –ø–∞—É–∑—ã/–Ω–∞—á–∞–ª–∞. –î–ª—è –¥–≤–∏–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–°–¢–†–ï–õ–ö–ò**.</p>
        
        <div id="reset-controls" style="margin-top: 20px; display: none;">
            <p id="final-score-message" style="font-size: 1.5em; color: #2ecc71;"></p>
            <p id="gained-coins-message" style="font-size: 1.2em; color: gold;"></p>
            <button onclick="resetGame()" style="background-color: #f1c40f; color: #333; padding: 10px 20px;">–°—ã–≥—Ä–∞—Ç—å –°–Ω–æ–≤–∞</button>
            <button class="back-button" onclick="showTab('main-menu-content')">‚Üê –í—ã–π—Ç–∏ –≤ –ú–µ–Ω—é</button>
        </div>
    </div>


    <div id="shop-content" class="tab-content">
        <h2>üõí –ú–∞–≥–∞–∑–∏–Ω –°–∫–∏–Ω–æ–≤ –∏ –ë—É—Å—Ç–µ—Ä–æ–≤</h2>
        
        <h3>–°–∫–∏–Ω—ã –ó–º–µ–π–∫–∏</h3>
        <div id="skins-list">
            </div>

        <h3 style="margin-top: 40px;">–ë—É—Å—Ç–µ—Ä—ã (–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ)</h3>
        <div id="booster-shop-list" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
            </div>
    </div>
    
    
    <div id="inventory-content" class="tab-content">
        <h2>üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
        
        <div id="admin-controls" style="margin-bottom: 20px;">
             <button onclick="showAdminPanel()" style="background-color: #9b59b6; color: white;">üëë Admin</button>
        </div>
        
        <h3>–í–∞—à–∏ –°–∫–∏–Ω—ã –ó–º–µ–π–∫–∏</h3>
        <div id="inventory-skins-list">
            </div>

        <h3 style="margin-top: 40px;">–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è (–°–ª–µ–¥—ã)</h3>
        <div id="inventory-trails-list">
             </div>

        <h3 style="margin-top: 40px;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ë—É—Å—Ç–µ—Ä—ã</h3>
        <div id="inventory-boosters-list" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
             </div>
        
        <h3 style="margin-top: 40px;">–ü—Ä–æ–º–æ–∫–æ–¥—ã</h3>
        <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø—Ä–æ–º–æ–∫–æ–¥:</p>
        <input type="text" id="promocode-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" style="padding: 8px; width: 250px; margin-bottom: 10px;">
        <button onclick="applyPromocode()" style="background-color: #2ecc71; color: white; padding: 8px 15px;">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
        <p id="promocode-message" style="color: yellow;"></p>
    </div>
    
    <div id="admin-panel">
        <h2 style="color: white;">üëë –ê–î–ú–ò–ù –ê–ö–¢–ò–í–ê–¶–ò–Ø</h2>
        <p style="color: #ccc;">–í–≤–µ–¥–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–¥, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø:</p>
        <input type="password" id="admin-input" placeholder="ADMIN_CODE">
        <button onclick="activateAdminMode()">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</button>
        <button onclick="closeAdminPanel()">‚Üê –ù–∞–∑–∞–¥</button>
        <p id="admin-message" style="color: red; margin-top: 10px;"></p>
    </div>


    <div id="cases-content" class="tab-content">
        <h2>üîë –ö–µ–π—Å—ã</h2>
        
        <div style="display: flex; justify-content: center; align-items: flex-start; gap: 30px;">
            <div id="available-cases" style="text-align: left; width: 300px; padding: 20px; border: 2px solid #f1c40f; border-radius: 8px; background-color: #2c3e50;">
                <h3>–í–∞—à–∏ –ö–µ–π—Å—ã</h3>
                <p>–ë–∞–∑–æ–≤—ã–π –ö–µ–π—Å: <span id="basic-cases-count">0</span> —à—Ç.</p>
                <button onclick="openCase('basic')" style="background-color: #3498db; color: white; padding: 10px 15px; margin-top: 10px;">–û—Ç–∫—Ä—ã—Ç—å –ë–∞–∑–æ–≤—ã–π</button>
                <p style="margin-top: 10px; font-size: 0.9em;">(–®–∞–Ω—Å: 50% –û–±—ã—á–Ω, 35% –†–µ–¥–∫, 10% –≠–ø–∏—á, 5% –õ–µ–≥–µ–Ω–¥)</p>
            </div>
            
            <div id="case-results" style="width: 700px;">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –û—Ç–∫—Ä—ã—Ç–∏—è</h3>
                <div id="case-result-wrapper">
                    <div id="skin-roll">
                        </div>
                </div>
                <p id="roll-message" style="color: yellow; font-size: 1.2em; margin-top: 10px;">–ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å", —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!</p>
                <p id="roll-win-message" style="font-size: 1.5em; font-weight: bold;"></p>
            </div>
        </div>
    </div>


    <div id="stats-content" class="tab-content">
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <h3>üí∞ –í—Å–µ–≥–æ –ú–æ–Ω–µ—Ç –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</h3>
                <p id="stat-total-coins" style="font-size: 1.8em; color: gold;">0</p>
            </div>
            <div class="stat-item">
                <h3>üèÜ –õ—É—á—à–∏–π –°—á–µ—Ç</h3>
                <p id="stat-high-score" style="font-size: 1.8em; color: #2ecc71;">0</p>
            </div>
            <div class="stat-item">
                <h3>üêç –°—ä–µ–¥–µ–Ω–æ –ï–¥—ã</h3>
                <p id="stat-food-eaten" style="font-size: 1.8em; color: #e74c3c;">0</p>
            </div>
            <div class="stat-item">
                <h3>üîÑ –°—ã–≥—Ä–∞–Ω–æ –ò–≥—Ä</h3>
                <p id="stat-games-played" style="font-size: 1.8em; color: #f1c40f;">0</p>
            </div>
        </div>
    </div>


    <div id="achievements-content" class="tab-content">
        <h2>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        <div class="achievement-grid" id="achievement-grid">
            </div>
    </div>


    <script>
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 25; // –†–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏
        const tileCount = canvas.width / gridSize;
        
        let snake = [];
        let food = {};
        let dx = 1; // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ X
        let dy = 0; // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ Y
        let speed = 100; // –°–∫–æ—Ä–æ—Å—Ç—å (–º—Å)
        let gameLoopInterval;
        let isGameRunning = false;
        let isPaused = false;
        
        // V1.4: –†–ï–ñ–ò–ú–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò
        let currentMapMode = 'classic';
        let currentDifficulty = 100;
        let walls = [];
        let portal1 = null;
        let portal2 = null;
        let narrowingWallSize = 0; // –î–ª—è —Ä–µ–∂–∏–º–∞ "–°—É–∂–µ–Ω–∏–µ"
        let narrowingTimerInterval; // –¢–∞–π–º–µ—Ä –¥–ª—è —Å—É–∂–µ–Ω–∏—è
        let orcDenMultiplier = 1; // –î–ª—è —Å–æ–±—ã—Ç–∏—è "–õ–æ–≥–æ–≤–æ –û—Ä–∫–∞"
        let meteorInterval; // –î–ª—è —Å–æ–±—ã—Ç–∏—è "–ú–µ—Ç–µ–æ—Ä–∏—Ç–Ω—ã–π –¥–æ–∂–¥—å"

        // V1.4: –ü–†–û–ì–†–ï–°–° –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê
        let score = 0;
        let coins = 0;
        let stats = {
            totalCoins: 0,
            highScore: 0,
            foodEaten: 0,
            gamesPlayed: 0,
        };
        
        // V1.4: –ò–ù–í–ï–ù–¢–ê–†–¨ –ò –ë–ê–§–§–´
        let inventory = {
            skins: ['green'], // –ù–∞—á–∞–ª—å–Ω—ã–π —Å–∫–∏–Ω
            trails: ['none'], // –ù–∞—á–∞–ª—å–Ω—ã–π —Å–ª–µ–¥
            equippedSkin: 'green',
            equippedTrail: 'none',
            boosters: {
                doubleScore: 0,
                slowMotion: 0,
                reverseControl: 0,
            },
            cases: {
                basic: 0,
            },
            achievements: {}, // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∫ –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç, –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –≤ loadProgress
        };

        // V1.4: –ê–ö–¢–ò–í–ù–´–ï –ë–£–°–¢–ï–†–´ –ò –¢–ê–ô–ú–ï–†–´
        let activeBoosters = {
            doubleScore: false,
            slowMotion: false,
            reverseControl: false,
        };
        let boosterTimers = {
            doubleScore: 0,
            slowMotion: 0,
            reverseControl: 0,
        };
        let timerIntervals = {};
        
        // --- –î–ê–ù–ù–´–ï –ò–ì–†–´ ---

        const PROMOCODES = {
            FREE_CASE: { reward: { cases: { basic: 1 } }, message: "–ü–æ–ª—É—á–µ–Ω –ë–∞–∑–æ–≤—ã–π –ö–µ–π—Å!" },
            BONUS_500: { reward: { coins: 500 }, message: "–ü–æ–ª—É—á–µ–Ω–æ 500 –º–æ–Ω–µ—Ç!" },
        };

        const SKINS = {
            'green': { name: '–ó–µ–ª–µ–Ω—ã–π', color: '#2ecc71', head: '#27ae60', rarity: 'common', price: 0 },
            'blue': { name: '–°–∏–Ω–∏–π', color: '#3498db', head: '#2980b9', rarity: 'common', price: 100 },
            'red': { name: '–ö—Ä–∞—Å–Ω—ã–π', color: '#e74c3c', head: '#c0392b', rarity: 'common', price: 100 },
            'gold': { name: '–ó–æ–ª–æ—Ç–æ–π', color: '#f1c40f', head: '#f39c12', rarity: 'rare', price: 500 },
            'rainbow': { name: '–†–∞–¥—É–≥–∞', color: 'rainbow', head: '#ecf0f1', rarity: 'legendary', price: 5000 }, 
            'orc-skin': { name: '–û—Ä–∫', color: '#7f8c8d', head: '#5b6a6b', rarity: 'mythical', price: 10000 },
        };
        
        const TRAILS = {
             'none': { name: '–ù–µ—Ç', type: 'none', color: null, rarity: 'common', price: 0 },
             'basic': { name: '–¢–æ—á–∫–∞', type: 'dot', color: '#e67e22', rarity: 'common', price: 100 },
             'sparkle': { name: '–ò—Å–∫—Ä–∞', type: 'sparkle', color: '#f1c40f', rarity: 'rare', price: 800 },
        };
        
        const BOOSTERS = {
            'doubleScore': { name: 'x2 –û—á–∫–∏', description: '–£–¥–≤–æ–µ–Ω–∏–µ –æ—á–∫–æ–≤ –Ω–∞ 30 —Å–µ–∫.', duration: 30, price: 100, icon: 'üöÄ' },
            'slowMotion': { name: '–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ', description: '–ó–∞–º–µ–¥–ª—è–µ—Ç –∏–≥—Ä—É –Ω–∞ 15 —Å–µ–∫.', duration: 15, price: 200, icon: 'üê¢' },
            'reverseControl': { name: '–†–µ–≤–µ—Ä—Å', description: '–ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤ –Ω–∞ 10 —Å–µ–∫.', duration: 10, price: 500, icon: '‚ö†Ô∏è' },
        };

        const ACHIEVEMENTS = {
            firstKill: { name: '–ü–µ—Ä–≤–∞—è –ö–ª–µ—Ç–∫–∞', description: '–°—ä–µ—Å—Ç—å –ø–µ—Ä–≤—É—é –µ–¥—É.', unlocked: false, reward: 100 },
            hungrySnake: { name: '–ü—Ä–æ–≥–ª–æ—Ç', description: '–°—ä–µ—Å—Ç—å 50 –µ–¥—ã –∑–∞ –∏–≥—Ä—É.', unlocked: false, reward: 500 },
            highRoller: { name: '–•–∞–π—Ä–æ–ª–ª–µ—Ä', description: '–ù–∞–±—Ä–∞—Ç—å 500 –æ—á–∫–æ–≤.', unlocked: false, reward: 1000 },
            wallMaster: { name: '–ú–∞—Å—Ç–µ—Ä –°—Ç–µ–Ω', description: '–°—ã–≥—Ä–∞—Ç—å –≤ —Ä–µ–∂–∏–º–µ "–°—Ç–µ–Ω—ã".', unlocked: false, reward: 200 },
            adminAccess: { name: '–ê–¥–º–∏–Ω', description: '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –∫–æ–¥.', unlocked: false, reward: 0 },
            caseOpener: { name: '–ö–µ–π—Å–æ–æ—Ç–∫—Ä—ã–≤–∞—Ç–µ–ª—å', description: '–û—Ç–∫—Ä—ã—Ç—å 5 –∫–µ–π—Å–æ–≤.', unlocked: false, reward: 300 },
            orcSlayer: { name: '–£–±–∏–π—Ü–∞ –û—Ä–∫–æ–≤', description: '–ù–∞–±—Ä–∞—Ç—å 100 –æ—á–∫–æ–≤ –≤ —Ä–µ–∂–∏–º–µ "–õ–æ–≥–æ–≤–æ –û—Ä–∫–∞".', unlocked: false, reward: 2000 },
        };
        
        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –°–û–•–†–ê–ù–ï–ù–ò–ï ---

        function init() {
            loadProgress();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ–Ω—é
            showTab('main-menu-content'); 

            renderProgression();
            
            document.getElementById('current-skin-name').textContent = SKINS[inventory.equippedSkin].name;
            document.getElementById('current-trail-name').textContent = TRAILS[inventory.equippedTrail].name;

            document.addEventListener('keydown', keyPush);
            window.addEventListener('blur', pauseGame); 

            for (const key in timerIntervals) {
                 clearInterval(timerIntervals[key]);
            }
        }

        function saveProgress(showConfirmation = false) {
            const data = {
                coins: coins,
                stats: stats,
                inventory: inventory
            };
            localStorage.setItem('snakeGameProgress', JSON.stringify(data));
            if (showConfirmation) {
                alert('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            }
        }

        function loadProgress() {
            const savedData = localStorage.getItem('snakeGameProgress');
            if (savedData) {
                const data = JSON.parse(savedData);
                coins = data.coins || 0;
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                stats = { ...stats, ...data.stats };
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
                inventory = { 
                    ...inventory, 
                    ...(data.inventory || {}), 
                    boosters: { ...inventory.boosters, ...((data.inventory && data.inventory.boosters) || {}) },
                    cases: { ...inventory.cases, ...((data.inventory && data.inventory.cases) || {}) },
                    achievements: { ...inventory.achievements, ...((data.inventory && data.inventory.achievements) || {}) }
                };
            }
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
            for (const key in ACHIEVEMENTS) {
                 if (inventory.achievements[key] === undefined) {
                     inventory.achievements[key] = ACHIEVEMENTS[key].unlocked;
                 }
            }
            renderProgression();
        }

        function renderProgression() {
            document.getElementById('coins').textContent = coins;
            document.getElementById('score').textContent = score;
            document.getElementById('cases-count').textContent = inventory.cases.basic;
        }
        
        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ö–†–ò–¢–ò–ß–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø) ---

        function showTab(tabId) {
            // 1. –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º style.display –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            });
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.style.display = 'block'; 
                targetTab.classList.add('active');
            }

            // 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª—å—é
            const headerBar = document.getElementById('header-bar');
            if (tabId === 'main-menu-content') {
                headerBar.style.display = 'none';
            } else {
                headerBar.style.display = 'flex';
            }
            
            // 4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–Ω–¥–µ—Ä—ã –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
            if (tabId === 'shop-content') renderShop();
            if (tabId === 'inventory-content') renderInventory();
            if (tabId === 'stats-content') renderStats();
            if (tabId === 'achievements-content') renderAchievements();
            if (tabId === 'cases-content') renderCases();
            if (tabId === 'difficulty-menu-content') renderDifficultyMenuBoosters(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É—Å—Ç–µ—Ä–æ–≤
            
            // 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏
            document.getElementById('progression-display').style.display = (tabId === 'game-content') ? 'none' : 'flex';
        }
        
        // --- –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ---

        function startGame() {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            if (narrowingTimerInterval) clearInterval(narrowingTimerInterval);
            if (meteorInterval) clearInterval(meteorInterval);

            // –°–±—Ä–æ—Å –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            snake = [{ x: 10, y: 10 }];
            dx = 1;
            dy = 0;
            score = 0;
            isGameRunning = true;
            isPaused = false;
            
            // –°–±—Ä–æ—Å –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–æ–≤
            walls = [];
            portal1 = null;
            portal2 = null;
            narrowingWallSize = 0;
            orcDenMultiplier = 1;

            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—É—Å—Ç–µ—Ä–æ–≤ –∏ —Ç–∞–π–º–µ—Ä–æ–≤
            for(const key in activeBoosters) {
                 activeBoosters[key] = false;
            }
            for(const key in boosterTimers) {
                 boosterTimers[key] = 0;
            }
            activateSelectedBoosters(); 
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏
            speed = currentDifficulty;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞ –∫–∞—Ä—Ç—ã
            setupMapMode(currentMapMode);
            
            // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
            generateFood();
            gameLoopInterval = setInterval(gameLoop, speed);
            document.getElementById('game-message').textContent = '';
            document.getElementById('reset-controls').style.display = 'none';
            
            showTab('game-content');
            
            // V1.4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            stats.gamesPlayed++;
        }
        
        function setupMapMode(mode) {
             // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ–≤–µ—Ä–ª–µ–∏
             document.getElementById('orc-den-status').style.display = 'none';
             document.getElementById('narrowing-timer').style.display = 'none';

             if (mode === 'walls') {
                 generateWalls();
             } else if (mode === 'portal') {
                 generatePortals();
             } else if (mode === 'narrowing') {
                 startNarrowingTimer();
                 document.getElementById('narrowing-timer').style.display = 'flex';
             } else if (mode === 'orc-den') {
                 orcDenMultiplier = 3; // –£—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç—ã/–æ—á–∫–∏
                 document.getElementById('orc-den-status').style.display = 'flex';
                 document.getElementById('orc-den-status-value').textContent = '–í–∫–ª—é—á–µ–Ω–æ';
                 // –ó–∞–ø—É—Å–∫ –º–µ—Ç–µ–æ—Ä–∏—Ç–Ω–æ–≥–æ –¥–æ–∂–¥—è (–¥–ª—è –æ—Ä–∫–∞)
                 meteorInterval = setInterval(generateMeteor, 5000); 
             }
        }
        
        function gameLoop() {
            if (!isGameRunning || isPaused) return;

            // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≥–æ–ª–æ–≤—ã
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
            if (checkCollision(head)) {
                endGame();
                return;
            }

            // 3. –ü–æ—Ä—Ç–∞–ª—ã
            if (currentMapMode === 'portal') {
                if (head.x === portal1.x && head.y === portal1.y) {
                    head.x = portal2.x;
                    head.y = portal2.y;
                } else if (head.x === portal2.x && head.y === portal2.y) {
                    head.x = portal1.x;
                    head.y = portal1.y;
                }
            }
            
            // 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –≥–æ–ª–æ–≤—ã
            snake.unshift(head);
            
            // 5. –ï–¥–∞
            if (head.x === food.x && head.y === food.y) {
                // –°—ä–µ–ª–∏
                processFoodEaten();
            } else {
                // –ù–µ —Å—ä–µ–ª–∏ - —É–¥–∞–ª—è–µ–º —Ö–≤–æ—Å—Ç
                snake.pop();
            }
            
            // 6. –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            drawGame();
        }
        
        function processFoodEaten() {
            let scoreIncrease = 1;
            let coinsGained = 1;

            if (activeBoosters.doubleScore) {
                scoreIncrease *= 2;
                coinsGained *= 2;
            }
            if (currentMapMode === 'orc-den') {
                 scoreIncrease *= orcDenMultiplier;
                 coinsGained *= orcDenMultiplier;
            }
            
            score += scoreIncrease;
            coins += coinsGained;
            stats.totalCoins += coinsGained;
            stats.foodEaten++;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            if (stats.foodEaten >= 50 && !inventory.achievements.hungrySnake) {
                 unlockAchievement('hungrySnake');
            }

            generateFood();
            renderProgression();
        }

        function checkCollision(head) {
            // 1. –ì—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—è
            if (currentMapMode === 'classic' || currentMapMode === 'orc-den' || currentMapMode === 'narrowing') {
                if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                    return true;
                }
            } else { // –†–µ–∂–∏–º—ã "–°—Ç–µ–Ω—ã" –∏ "–ü–æ—Ä—Ç–∞–ª—ã" (–ø—Ä–æ—Ö–æ–¥ —Å–∫–≤–æ–∑—å –≥—Ä–∞–Ω–∏—Ü—ã)
                if (head.x < 0) head.x = tileCount - 1;
                if (head.x >= tileCount) head.x = 0;
                if (head.y < 0) head.y = tileCount - 1;
                if (head.y >= tileCount) head.y = 0;
            }

            // 2. –°—Ç–µ–Ω—ã (–¥–ª—è —Ä–µ–∂–∏–º–æ–≤ "–°—Ç–µ–Ω—ã", "–°—É–∂–µ–Ω–∏–µ" –∏ "–õ–æ–≥–æ–≤–æ –û—Ä–∫–æ–≤")
            if (currentMapMode === 'walls' || currentMapMode === 'narrowing' || currentMapMode === 'orc-den') {
                if (walls.some(wall => wall.x === head.x && wall.y === head.y)) {
                    return true;
                }
                if (currentMapMode === 'narrowing') {
                     // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É–∂–∞—é—â–∏–µ—Å—è —Å—Ç–µ–Ω—ã
                    if (head.x < narrowingWallSize || head.x >= tileCount - narrowingWallSize ||
                        head.y < narrowingWallSize || head.y >= tileCount - narrowingWallSize) {
                        return true;
                    }
                }
            }

            // 3. –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Å–æ–±–æ–π
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    return true;
                }
            }
            
            return false;
        }

        function generateFood() {
            let newFood;
            let occupied = true;
            
            while (occupied) {
                newFood = {
                    x: Math.floor(Math.random() * tileCount),
                    y: Math.floor(Math.random() * tileCount)
                };
                
                occupied = snake.some(segment => segment.x === newFood.x && segment.y === newFood.y) ||
                           walls.some(wall => wall.x === newFood.x && wall.y === newFood.y);
                
                if (currentMapMode === 'portal' && (newFood.x === portal1.x && newFood.y === portal1.y || newFood.x === portal2.x && newFood.y === portal2.y)) {
                    occupied = true;
                }
            }
            food = newFood;
        }
        
        // --- –†–ï–ñ–ò–ú–´ –ö–ê–†–¢–´ ---

        function generateWalls() {
            walls = [];
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –ª–∞–±–∏—Ä–∏–Ω—Ç (–ø—Ä–∏–º–µ—Ä)
            for (let i = 5; i < 20; i++) {
                walls.push({ x: 10, y: i });
                walls.push({ x: 20, y: i });
            }
            if (!inventory.achievements.wallMaster) {
                 unlockAchievement('wallMaster');
            }
        }
        
        function generatePortals() {
            // –ü–æ—Ä—Ç–∞–ª—ã –≤ —Å–ª—É—á–∞–π–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
            portal1 = { x: 5, y: 5 };
            portal2 = { x: 25, y: 25 };
        }
        
        function startNarrowingTimer() {
            narrowingWallSize = 0;
            let narrowCount = 0;
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
            if (narrowingTimerInterval) clearInterval(narrowingTimerInterval);

            narrowingTimerInterval = setInterval(() => {
                narrowCount++;
                const remaining = 30 - narrowCount;
                document.getElementById('narrowing-timer-value').textContent = `${remaining}—Å`;

                if (narrowCount % 6 === 0) { // –ö–∞–∂–¥—ã–µ 6 —Å–µ–∫—É–Ω–¥ —Å—É–∂–∞–µ–º
                    narrowingWallSize++;
                }

                if (remaining <= 0) {
                    // –°—É–∂–µ–Ω–∏–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å, –∏–ª–∏ –∏–≥—Ä–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è
                    clearInterval(narrowingTimerInterval);
                    document.getElementById('narrowing-timer-value').textContent = '–§–ò–ù–ê–õ';
                }
            }, 1000);
        }

        function generateMeteor() {
            if (isGameRunning && !isPaused) {
                // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–µ–æ—Ä–∏—Ç (–æ–Ω –∂–µ —Å—Ç–µ–Ω–∞) –≤ —Å–ª—É—á–∞–π–Ω–æ–º –º–µ—Å—Ç–µ
                let meteorWall;
                let safe = false;
                
                while (!safe) {
                    meteorWall = {
                        x: Math.floor(Math.random() * tileCount),
                        y: Math.floor(Math.random() * tileCount)
                    };
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –º–µ—Ç–µ–æ—Ä–∏—Ç –Ω–µ —É–ø–∞–ª –ø—Ä—è–º–æ –Ω–∞ –≥–æ–ª–æ–≤—É –∑–º–µ–π–∫–∏ –∏–ª–∏ –µ–¥—É
                    if (!snake.some(segment => segment.x === meteorWall.x && segment.y === meteorWall.y) &&
                        !(food.x === meteorWall.x && food.y === meteorWall.y)) {
                        safe = true;
                    }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–µ–æ—Ä–∏—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏—Å—á–µ–∑–Ω–µ—Ç —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫
                walls.push(meteorWall);
                setTimeout(() => {
                    walls = walls.filter(w => w !== meteorWall);
                }, 1500);
            }
        }
        
        // --- –ë–£–°–¢–ï–†–´ ---
        
        function activateSelectedBoosters() {
             // –ê–∫—Ç–∏–≤–Ω—ã–µ –±—É—Å—Ç–µ—Ä—ã –∏–∑ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
             const selectedBoosters = JSON.parse(localStorage.getItem('selectedBoosters') || '{}');
             localStorage.removeItem('selectedBoosters'); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
             
             for (const key in selectedBoosters) {
                 if (selectedBoosters[key] === true && inventory.boosters[key] > 0) {
                      activeBoosters[key] = true;
                      inventory.boosters[key]--;
                      startBoosterTimer(key, BOOSTERS[key].duration);
                 }
             }
             saveProgress(); 
             renderInventory(); 
        }

        function startBoosterTimer(boosterKey, duration) {
            let timer = duration;
            const displayId = 'buff-timer-' + boosterKey.toLowerCase().replace(/([A-Z])/g, '-$1');
            const displayValueId = displayId + '-value';
            
            document.getElementById(displayId).style.display = 'flex';
            
            if (timerIntervals[boosterKey]) clearInterval(timerIntervals[boosterKey]);

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            if (boosterKey === 'slowMotion') {
                 // –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–¥–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
                 clearInterval(gameLoopInterval);
                 gameLoopInterval = setInterval(gameLoop, speed * 2);
            }
            
            timerIntervals[boosterKey] = setInterval(() => {
                timer--;
                document.getElementById(displayValueId).textContent = `${timer}—Å`;
                boosterTimers[boosterKey] = timer; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è

                if (timer <= 0) {
                    clearInterval(timerIntervals[boosterKey]);
                    activeBoosters[boosterKey] = false;
                    document.getElementById(displayId).style.display = 'none';

                    // –û—Ç–º–µ–Ω—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
                    if (boosterKey === 'slowMotion') {
                        clearInterval(gameLoopInterval);
                        gameLoopInterval = setInterval(gameLoop, speed);
                    }
                    if (boosterKey === 'reverseControl') {
                        // –°–±—Ä–æ—Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ —Ä–µ–≤–µ—Ä—Å –æ—Ç–∫–ª—é—á–∏–ª—Å—è
                         dx = -dx;
                         dy = -dy;
                    }
                }
            }, 1000);
        }

        
        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò –ü–ê–£–ó–ê ---

        function keyPush(event) {
            if (event.code === 'Space') {
                event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª
                togglePause();
                return;
            }
            
            if (!isGameRunning || isPaused) return;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            let newDx = dx;
            let newDy = dy;
            
            switch (event.code) {
                case 'ArrowLeft': newDx = -1; newDy = 0; break;
                case 'ArrowUp': newDx = 0; newDy = -1; break;
                case 'ArrowRight': newDx = 1; newDy = 0; break;
                case 'ArrowDown': newDx = 0; newDy = 1; break;
                default: return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–≤–µ—Ä—Å
            if (activeBoosters.reverseControl) {
                 newDx = -newDx;
                 newDy = -newDy;
            }

            // –ù–µ–ª—å–∑—è –¥–≤–∏–≥–∞—Ç—å—Å—è –Ω–∞–∑–∞–¥
            if (newDx !== -dx || newDy !== -dy) {
                dx = newDx;
                dy = newDy;
            }
        }
        
        function togglePause() {
            if (!isGameRunning) return;
            isPaused = !isPaused;

            const messageElement = document.getElementById('game-message');
            const infoElement = document.getElementById('game-info');

            if (isPaused) {
                clearInterval(gameLoopInterval);
                // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∞–π–º–µ—Ä–æ–≤ –ø—Ä–∏ –ø–∞—É–∑–µ
                for (const key in timerIntervals) {
                    clearInterval(timerIntervals[key]);
                }
                if (narrowingTimerInterval) clearInterval(narrowingTimerInterval);
                if (meteorInterval) clearInterval(meteorInterval);
                
                messageElement.textContent = '–ü–ê–£–ó–ê';
                infoElement.style.display = 'none';
            } else {
                gameLoopInterval = setInterval(gameLoop, speed);
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–π–º–µ—Ä–æ–≤
                for (const key in boosterTimers) {
                    if (boosterTimers[key] > 0) {
                        startBoosterTimer(key, boosterTimers[key]);
                    }
                }
                if (currentMapMode === 'narrowing') {
                    startNarrowingTimer();
                }
                if (currentMapMode === 'orc-den') {
                    meteorInterval = setInterval(generateMeteor, 5000);
                }
                
                messageElement.textContent = '';
                infoElement.style.display = 'block';
            }
        }

        function pauseGame() {
            if (isGameRunning && !isPaused) {
                 togglePause();
            }
        }
        
        function endGame() {
            isGameRunning = false;
            clearInterval(gameLoopInterval);
            if (narrowingTimerInterval) clearInterval(narrowingTimerInterval);
            if (meteorInterval) clearInterval(meteorInterval);

            // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∞–π–º–µ—Ä–æ–≤
            for (const key in timerIntervals) {
                 clearInterval(timerIntervals[key]);
            }
            
            document.getElementById('game-message').textContent = '–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê!';
            
            // V1.4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            let gainedCoins = score + (currentMapMode === 'orc-den' ? 100 : 0);
            
            document.getElementById('final-score-message').textContent = `–í–∞—à —Å—á–µ—Ç: ${score}!`;
            document.getElementById('gained-coins-message').textContent = `–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${gainedCoins} üí∞ –º–æ–Ω–µ—Ç.`;
            document.getElementById('reset-controls').style.display = 'block';
            document.getElementById('game-info').style.display = 'none';

            coins += gainedCoins;
            stats.totalCoins += gainedCoins;
            if (score > stats.highScore) {
                stats.highScore = score;
            }
            // V1.4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            if (score >= 500 && !inventory.achievements.highRoller) {
                unlockAchievement('highRoller');
            }
            if (currentMapMode === 'orc-den' && score >= 100 && !inventory.achievements.orcSlayer) {
                 unlockAchievement('orcSlayer');
            }

            saveProgress();
            renderProgression();
        }
        
        function resetGame() {
             showTab('difficulty-menu-content');
        }

        // --- –ì–†–ê–§–ò–ö–ê –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï ---

        function drawGame() {
            // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –°—Ç–µ–Ω (–≤–∫–ª—é—á–∞—è —Å—É–∂–µ–Ω–∏–µ –∏ –º–µ—Ç–µ–æ—Ä–∏—Ç—ã)
            ctx.fillStyle = '#7f8c8d'; 
            walls.forEach(wall => {
                ctx.fillRect(wall.x * gridSize, wall.y * gridSize, gridSize - 1, gridSize - 1);
            });
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—É–∂–∞—é—â–∏—Ö—Å—è —Å—Ç–µ–Ω
            if (currentMapMode === 'narrowing') {
                 ctx.fillStyle = '#E74C3C';
                 // –í–µ—Ä—Ö–Ω—è—è –∏ –Ω–∏–∂–Ω—è—è
                 for (let x = 0; x < tileCount; x++) {
                     for (let i = 0; i < narrowingWallSize; i++) {
                          ctx.fillRect(x * gridSize, i * gridSize, gridSize - 1, gridSize - 1);
                          ctx.fillRect(x * gridSize, (tileCount - 1 - i) * gridSize, gridSize - 1, gridSize - 1);
                     }
                 }
                 // –õ–µ–≤–∞—è –∏ –ø—Ä–∞–≤–∞—è (–∏—Å–∫–ª—é—á–∞—è —É–≥–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω—ã)
                 for (let y = narrowingWallSize; y < tileCount - narrowingWallSize; y++) {
                     for (let i = 0; i < narrowingWallSize; i++) {
                          ctx.fillRect(i * gridSize, y * gridSize, gridSize - 1, gridSize - 1);
                          ctx.fillRect((tileCount - 1 - i) * gridSize, y * gridSize, gridSize - 1, gridSize - 1);
                     }
                 }
            }

            // 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ü–æ—Ä—Ç–∞–ª–æ–≤
            if (currentMapMode === 'portal' && portal1 && portal2) {
                 ctx.fillStyle = '#9b59b6';
                 ctx.fillRect(portal1.x * gridSize, portal1.y * gridSize, gridSize, gridSize);
                 ctx.fillRect(portal2.x * gridSize, portal2.y * gridSize, gridSize, gridSize);
            }
            
            // 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ï–¥—ã
            ctx.fillStyle = 'red';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 1, gridSize - 1);

            // 4. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ó–º–µ–π–∫–∏ –∏ –°–ª–µ–¥–æ–≤
            const skinData = SKINS[inventory.equippedSkin];
            const trailData = TRAILS[inventory.equippedTrail];

            for (let i = 0; i < snake.length; i++) {
                const segment = snake[i];
                let color;
                
                if (i === 0) {
                    // –ì–õ–ê–í–ê –ó–ú–ï–ô–ö–ò
                    color = skinData.head;
                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ï—Å–ª–∏ —Å–∫–∏–Ω "–†–∞–¥—É–≥–∞", –≥–æ–ª–æ–≤–∞ –≤—Å–µ–≥–¥–∞ –±–µ–ª–∞—è
                    if (inventory.equippedSkin === 'rainbow') {
                         color = '#ecf0f1';
                    }
                } else {
                    // –¢–ï–õ–û –ó–ú–ï–ô–ö–ò
                    if (skinData.color === 'rainbow') {
                        // –†–∞–¥—É–∂–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
                        const hue = (i * 10) % 360;
                        color = `hsl(${hue}, 100%, 50%)`;
                    } else {
                        color = skinData.color;
                    }
                    
                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –°–ª–µ–¥–∞ (–¢–û–õ–¨–ö–û –¥–ª—è —Ö–≤–æ—Å—Ç–∞, –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –µ–≥–æ –∑–∞–∫—Ä–∞—Å–∏—Ç—å)
                    if (trailData.type !== 'none' && i === snake.length - 1) {
                         drawTrailEffect(segment.x, segment.y, trailData);
                    }
                }

                ctx.fillStyle = color;
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 1, gridSize - 1);
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤ –Ω–∞ –æ–≤–µ—Ä–ª–µ–µ
            drawBoosterTimers();
        }
        
        function drawTrailEffect(x, y, trailData) {
            if (trailData.type === 'dot') {
                 // –ù–∞—Ä–∏—Å—É–µ–º –º–∞–ª–µ–Ω—å–∫–∏–π –∫—Ä—É–≥ (—Ç–æ—á–∫—É)
                 ctx.fillStyle = trailData.color;
                 ctx.beginPath();
                 ctx.arc(x * gridSize + gridSize / 2, y * gridSize + gridSize / 2, gridSize / 4, 0, Math.PI * 2);
                 ctx.fill();
            } else if (trailData.type === 'sparkle') {
                 // –ù–∞—Ä–∏—Å—É–µ–º –º–∞–ª–µ–Ω—å–∫—É—é –∑–≤–µ–∑–¥–æ—á–∫—É/–∫—Ä–µ—Å—Ç–∏–∫
                 ctx.fillStyle = trailData.color;
                 ctx.fillRect(x * gridSize + gridSize / 4, y * gridSize + gridSize / 2 - 1, gridSize / 2, 2);
                 ctx.fillRect(x * gridSize + gridSize / 2 - 1, y * gridSize + gridSize / 4, 2, gridSize / 2);
            }
        }
        
        function drawBoosterTimers() {
             for (const key in boosterTimers) {
                 const displayId = 'buff-timer-' + key.toLowerCase().replace(/([A-Z])/g, '-$1');
                 const displayValueId = displayId + '-value';

                 // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω
                 if (boosterTimers[key] > 0) {
                      document.getElementById(displayValueId).textContent = `${boosterTimers[key]}—Å`;
                 }
             }
        }

        // --- –ú–ê–ì–ê–ó–ò–ù –ò –ò–ù–í–ï–ù–¢–ê–†–¨ ---

        function renderShop() {
            const skinsList = document.getElementById('skins-list');
            skinsList.innerHTML = '';
            
            const boosterShopList = document.getElementById('booster-shop-list');
            boosterShopList.innerHTML = '';
            
            // –†–µ–Ω–¥–µ—Ä –°–∫–∏–Ω–æ–≤
            for (const key in SKINS) {
                const skin = SKINS[key];
                const isOwned = inventory.skins.includes(key);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'skin-item';
                itemDiv.innerHTML = `
                    <h4 class="rarity-${skin.rarity}">üêç ${skin.name}</h4>
                    <p>–†–µ–¥–∫–æ—Å—Ç—å: ${getRussianRarity(skin.rarity)}</p>
                    <div style="background-color: ${skin.head}; width: 30px; height: 30px; margin: 5px auto; border-radius: 5px;"></div>
                    ${isOwned 
                        ? '<p style="color: #2ecc71; font-weight: bold;">–ö–£–ü–õ–ï–ù–û</p>' 
                        : `<button onclick="buyItem('skin', '${key}', ${skin.price})">üí∞ –ö—É–ø–∏—Ç—å (${skin.price})</button>`
                    }
                `;
                skinsList.appendChild(itemDiv);
            }
            
            // –†–µ–Ω–¥–µ—Ä –ë—É—Å—Ç–µ—Ä–æ–≤
            for (const key in BOOSTERS) {
                 const booster = BOOSTERS[key];
                 const itemDiv = document.createElement('div');
                 itemDiv.className = 'booster-item';
                 itemDiv.style.width = '200px'; 
                 itemDiv.innerHTML = `
                     <h4>${booster.icon} ${booster.name}</h4>
                     <p>${booster.description}</p>
                     <button onclick="buyItem('booster', '${key}', ${booster.price})">üí∞ –ö—É–ø–∏—Ç—å (${booster.price})</button>
                 `;
                 boosterShopList.appendChild(itemDiv);
            }
        }
        
        function renderInventory() {
            // 1. –°–∫–∏–Ω—ã
            const invSkinsList = document.getElementById('inventory-skins-list');
            invSkinsList.innerHTML = '';
            
            inventory.skins.forEach(key => {
                const skin = SKINS[key];
                const isEquipped = inventory.equippedSkin === key;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'skin-item';
                itemDiv.innerHTML = `
                    <h4 class="rarity-${skin.rarity}">üêç ${skin.name}</h4>
                    <p>–†–µ–¥–∫–æ—Å—Ç—å: ${getRussianRarity(skin.rarity)}</p>
                    <div style="background-color: ${skin.head}; width: 30px; height: 30px; margin: 5px auto; border-radius: 5px;"></div>
                    ${isEquipped 
                        ? '<div class="equipped-status">–ê–ö–¢–ò–í–ï–ù</div>' 
                        : `<button onclick="equipItem('skin', '${key}')">–≠–ö–ò–ü–ò–†–û–í–ê–¢–¨</button>`
                    }
                `;
                invSkinsList.appendChild(itemDiv);
            });
            
            // 2. –°–ª–µ–¥—ã
            const invTrailsList = document.getElementById('inventory-trails-list');
            invTrailsList.innerHTML = '';
            
            for (const key in TRAILS) {
                 const trail = TRAILS[key];
                 if (inventory.trails.includes(key)) {
                    const isEquipped = inventory.equippedTrail === key;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'trail-item';
                    itemDiv.innerHTML = `
                        <h4 class="rarity-${trail.rarity}">‚ú® ${trail.name}</h4>
                        <div class="trail-preview">${trail.type === 'dot' ? '‚Ä¢' : trail.type === 'sparkle' ? '+' : ''}</div>
                        ${isEquipped 
                            ? '<div class="equipped-status">–ê–ö–¢–ò–í–ï–ù</div>' 
                            : `<button onclick="equipItem('trail', '${key}')">–≠–ö–ò–ü–ò–†–û–í–ê–¢–¨</button>`
                        }
                    `;
                    invTrailsList.appendChild(itemDiv);
                 }
            }
            
            // 3. –ë—É—Å—Ç–µ—Ä—ã
            const invBoostersList = document.getElementById('inventory-boosters-list');
            invBoostersList.innerHTML = '';
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º localStorage –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±—É—Å—Ç–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–π
            const selectedBoosters = JSON.parse(localStorage.getItem('selectedBoosters') || '{}');

            for (const key in inventory.boosters) {
                 if (inventory.boosters[key] > 0) {
                      const booster = BOOSTERS[key];
                      const isSelected = selectedBoosters[key] === true;
                      const itemDiv = document.createElement('div');
                      itemDiv.className = 'booster-item';
                      itemDiv.style.width = '200px'; 
                      itemDiv.innerHTML = `
                          <h4>${booster.icon} ${booster.name} (${inventory.boosters[key]})</h4>
                          <button class="${isSelected ? 'active' : ''}" onclick="selectBoosterForGame('${key}')">
                             ${isSelected ? '–û–¢–ú–ï–ù–ò–¢–¨' : '–í–´–ë–†–ê–¢–¨'}
                          </button>
                      `;
                      invBoostersList.appendChild(itemDiv);
                 }
            }
        }

        function buyItem(type, key, price) {
            if (coins < price) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
                return;
            }

            if (type === 'skin') {
                if(inventory.skins.includes(key)) {
                     alert('–≠—Ç–æ—Ç —Å–∫–∏–Ω —É–∂–µ –∫—É–ø–ª–µ–Ω!');
                     return;
                }
                inventory.skins.push(key);
                coins -= price;
                alert(`–í—ã –∫—É–ø–∏–ª–∏ —Å–∫–∏–Ω "${SKINS[key].name}"!`);
            } else if (type === 'booster') {
                inventory.boosters[key]++;
                coins -= price;
                alert(`–í—ã –∫—É–ø–∏–ª–∏ –±—É—Å—Ç–µ—Ä "${BOOSTERS[key].name}"!`);
            } else if (type === 'trail') {
                 if(inventory.trails.includes(key)) {
                     alert('–≠—Ç–æ—Ç —Å–ª–µ–¥ —É–∂–µ –∫—É–ø–ª–µ–Ω!');
                     return;
                 }
                 inventory.trails.push(key);
                 coins -= price;
                 alert(`–í—ã –∫—É–ø–∏–ª–∏ —Å–ª–µ–¥ "${TRAILS[key].name}"!`);
            }

            saveProgress();
            renderProgression();
            renderShop();
            renderInventory();
        }
        
        function equipItem(type, key) {
             if (type === 'skin') {
                 inventory.equippedSkin = key;
                 document.getElementById('current-skin-name').textContent = SKINS[key].name;
             } else if (type === 'trail') {
                 inventory.equippedTrail = key;
                 document.getElementById('current-trail-name').textContent = TRAILS[key].name;
             }
             saveProgress();
             renderInventory();
        }

        function selectBoosterForGame(key) {
             let selectedBoosters = JSON.parse(localStorage.getItem('selectedBoosters') || '{}');
             
             // –ï—Å–ª–∏ –±—É—Å—Ç–µ—Ä —É–∂–µ –±—ã–ª –≤—ã–±—Ä–∞–Ω, –æ—Ç–º–µ–Ω—è–µ–º –≤—ã–±–æ—Ä
             if (selectedBoosters[key]) {
                  delete selectedBoosters[key];
             } else {
                 // –ï—Å–ª–∏ –±—É—Å—Ç–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ, –≤—ã–±–∏—Ä–∞–µ–º –µ–≥–æ
                 if (inventory.boosters[key] > 0) {
                     selectedBoosters[key] = true;
                 } else {
                     alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—É—Å—Ç–µ—Ä–æ–≤ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ!');
                     return;
                 }
             }
             
             localStorage.setItem('selectedBoosters', JSON.stringify(selectedBoosters));
             renderInventory(); 
             renderDifficultyMenuBoosters(); 
        }
        
        function renderDifficultyMenuBoosters() {
             const list = document.getElementById('active-boosters-list');
             list.innerHTML = '';
             
             const selectedBoosters = JSON.parse(localStorage.getItem('selectedBoosters') || '{}');
             let found = false;
             
             for (const key in selectedBoosters) {
                  if (selectedBoosters[key] === true) {
                      found = true;
                      const booster = BOOSTERS[key];
                      const itemDiv = document.createElement('div');
                      itemDiv.className = 'booster-item';
                      itemDiv.innerHTML = `
                          <p style="margin: 0; font-weight: bold;">${booster.icon} ${booster.name}</p>
                          <button class="active" onclick="selectBoosterForGame('${key}')">–û–¢–ú–ï–ù–ò–¢–¨</button>
                      `;
                      list.appendChild(itemDiv);
                  }
             }

             if (!found) {
                  list.innerHTML = '<p style="margin-top: 5px;">–ë—É—Å—Ç–µ—Ä—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã. –í—ã–±–µ—Ä–∏—Ç–µ –≤ –ò–Ω–≤–µ–Ω—Ç–∞—Ä–µ.</p>';
             }
        }
        
        // --- –ü–†–û–ú–û–ö–û–î–´ –ò –ê–î–ú–ò–ù–ö–ê ---

        function showAdminPanel() {
             closeAdminPanel(); 
             document.getElementById('admin-panel').classList.add('active');
             document.getElementById('admin-input').focus();
             document.getElementById('admin-message').textContent = '';
             document.getElementById('admin-input').value = '';
        }
        
        function closeAdminPanel() {
             document.getElementById('admin-panel').classList.remove('active');
        }
        
        function activateAdminMode() {
            const adminCode = document.getElementById('admin-input').value.trim().toUpperCase();
            const messageElement = document.getElementById('admin-message');

            if (adminCode === 'ADMIN_GOLD') {
                coins += 1000000;
                stats.totalCoins += 1000000;
                messageElement.textContent = '–ê–¥–º–∏–Ω-–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –ü–æ–ª—É—á–µ–Ω–æ 1,000,000 üí∞!';
                messageElement.style.color = '#2ecc71';
                
                // –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
                if (!inventory.achievements.adminAccess) {
                     unlockAchievement('adminAccess');
                }
                
                saveProgress();
                renderProgression();
                
            } else {
                messageElement.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                messageElement.style.color = 'red';
            }
        }

        function applyPromocode() {
            const code = document.getElementById('promocode-input').value.trim().toUpperCase();
            const messageElement = document.getElementById('promocode-message');

            if (PROMOCODES[code]) {
                const promo = PROMOCODES[code];
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –ª–∏ —É–∂–µ –ø—Ä–æ–º–æ–∫–æ–¥ (–¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤)
                if (inventory.achievements['promo_' + code]) {
                     messageElement.textContent = '–≠—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!';
                     messageElement.style.color = 'red';
                     return;
                }
                
                // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã
                if (promo.reward.coins) {
                    coins += promo.reward.coins;
                    stats.totalCoins += promo.reward.coins;
                }
                if (promo.reward.cases) {
                    for (const caseType in promo.reward.cases) {
                         inventory.cases[caseType] = (inventory.cases[caseType] || 0) + promo.reward.cases[caseType];
                    }
                }
                
                // –ü–æ–º–µ—Ç–∫–∞ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
                inventory.achievements['promo_' + code] = true;
                
                messageElement.textContent = `–£—Å–ø–µ—à–Ω–æ! ${promo.message}`;
                messageElement.style.color = '#2ecc71';
                
                document.getElementById('promocode-input').value = '';
                saveProgress();
                renderProgression();
                renderInventory();
            } else {
                messageElement.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥.';
                messageElement.style.color = 'red';
            }
        }
        
        // --- –ö–ï–ô–°–´ ---

        function openCase(caseType) {
            if (inventory.cases[caseType] <= 0) {
                alert(`–£ –≤–∞—Å –Ω–µ—Ç –∫–µ–π—Å–æ–≤ —Ç–∏–ø–∞ "${caseType}"!`);
                return;
            }

            inventory.cases[caseType]--;
            
            // –õ–æ–≥–∏–∫–∞ —Ä–æ–ª–ª–∞ (—à–∞–Ω—Å—ã –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è)
            const roll = Math.random() * 100;
            let rarity;
            
            if (roll < 5) rarity = 'legendary'; 
            else if (roll < 15) rarity = 'epic'; 
            else if (roll < 50) rarity = 'rare'; 
            else rarity = 'common'; 
            
            // –í—ã–±–∏—Ä–∞–µ–º —Å–∫–∏–Ω —Å –≤—ã–ø–∞–≤—à–µ–π —Ä–µ–¥–∫–æ—Å—Ç—å—é
            const availableSkins = Object.keys(SKINS).filter(key => SKINS[key].rarity === rarity);
            const wonSkinKey = availableSkins[Math.floor(Math.random() * availableSkins.length)];
            const wonSkin = SKINS[wonSkinKey];

            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–∫–∏–Ω
            let alreadyOwned = inventory.skins.includes(wonSkinKey);
            
            if (!alreadyOwned) {
                 inventory.skins.push(wonSkinKey);
            } else {
                 // –ï—Å–ª–∏ —Å–∫–∏–Ω —É–∂–µ –µ—Å—Ç—å, –¥–∞–µ–º –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ–Ω–µ—Ç–∞–º–∏)
                 coins += 200;
                 stats.totalCoins += 200;
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —Ä–æ–ª–ª–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
            document.getElementById('roll-message').textContent = '–†–æ–ª–ª–∏–º...';
            document.getElementById('roll-win-message').textContent = '';

            const skinRollDiv = document.getElementById('skin-roll');
            skinRollDiv.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º 50 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (30 - –º–µ—Å—Ç–æ –≤—ã–∏–≥—Ä—ã—à–∞)
            for (let i = 0; i < 50; i++) {
                 let tempRarity = getRarityByRoll(Math.random() * 100);
                 let tempSkinKey = Object.keys(SKINS).filter(key => SKINS[key].rarity === tempRarity)[0];
                 const item = document.createElement('div');
                 item.className = 'roll-item';
                 item.classList.add('rarity-' + tempRarity);
                 item.textContent = SKINS[tempSkinKey].name;
                 skinRollDiv.appendChild(item);
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã–π —Å–∫–∏–Ω –Ω–∞ –ø–æ–∑–∏—Ü–∏—é 30
            const winItem = document.createElement('div');
            winItem.className = 'roll-item';
            winItem.classList.add('rarity-' + wonSkin.rarity);
            winItem.textContent = wonSkin.name;
            skinRollDiv.insertBefore(winItem, skinRollDiv.children[30]);

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            const itemWidth = 100; 
            const offset = (30 * itemWidth) - (700 / 2) + (itemWidth / 2);
            skinRollDiv.style.transition = 'transform 5s cubic-bezier(0.2, 0.9, 0.3, 1)';
            skinRollDiv.style.transform = `translateX(-${offset}px)`;

            setTimeout(() => {
                // –ü–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                skinRollDiv.style.transition = 'none';
                document.getElementById('roll-message').textContent = '';
                if (alreadyOwned) {
                     document.getElementById('roll-win-message').textContent = `üí• –ü–æ–≤—Ç–æ—Ä —Å–∫–∏–Ω–∞! –í—ã –ø–æ–ª—É—á–∏–ª–∏ 200 üí∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏.`;
                     document.getElementById('roll-win-message').style.color = 'yellow';
                } else {
                     document.getElementById('roll-win-message').textContent = `üéâ –ü–û–ë–ï–î–ê! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ —Å–∫–∏–Ω "${wonSkin.name}"!`;
                     document.getElementById('roll-win-message').style.color = wonSkin.rarity === 'legendary' ? '#FFD700' : '#2ecc71';
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                let casesOpenedCount = 0;
                // –°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ—Ç–∫—Ä—ã–ª–∏ –∫–µ–π—Å (—ç—Ç–æ –Ω–µ —Ç–æ—á–Ω–æ, –Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
                if (inventory.achievements.caseOpener) casesOpenedCount = 5; 
                // –ï—Å–ª–∏ —Ç—ã –Ω–µ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –∫–µ–π—Å—ã –æ—Ç–∫—Ä—ã–≤–∞–ª–∏—Å—å –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫:
                // stats.casesOpened++; 
                
                if (casesOpenedCount >= 5 && !inventory.achievements.caseOpener) {
                     unlockAchievement('caseOpener');
                }

                saveProgress();
                renderProgression();
                renderInventory(); 
                renderCases();
            }, 5000);
        }
        
        function getRarityByRoll(roll) {
            if (roll < 5) return 'legendary';
            if (roll < 15) return 'epic';
            if (roll < 50) return 'rare';
            return 'common';
        }

        function getRussianRarity(rarity) {
             switch (rarity) {
                 case 'common': return '–û–±—ã—á–Ω–∞—è';
                 case 'rare': return '–†–µ–¥–∫–∞—è';
                 case 'epic': return '–≠–ø–∏—á–µ—Å–∫–∞—è';
                 case 'legendary': return '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è';
                 case 'mythical': return '–ú–∏—Ñ–∏—á–µ—Å–∫–∞—è';
                 default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è';
             }
        }
        
        function renderCases() {
            document.getElementById('basic-cases-count').textContent = inventory.cases.basic;
        }

        // --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò –î–û–°–¢–ò–ñ–ï–ù–ò–Ø ---

        function renderStats() {
            document.getElementById('stat-total-coins').textContent = stats.totalCoins.toLocaleString();
            document.getElementById('stat-high-score').textContent = stats.highScore.toLocaleString();
            document.getElementById('stat-food-eaten').textContent = stats.foodEaten.toLocaleString();
            document.getElementById('stat-games-played').textContent = stats.gamesPlayed.toLocaleString();
        }

        function unlockAchievement(key) {
             const achievement = ACHIEVEMENTS[key];
             if (!inventory.achievements[key]) {
                  inventory.achievements[key] = true;
                  coins += achievement.reward;
                  stats.totalCoins += achievement.reward;
                  alert(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: "${achievement.name}"! –ù–∞–≥—Ä–∞–¥–∞: ${achievement.reward} üí∞`);
                  saveProgress();
                  renderProgression();
                  renderAchievements();
             }
        }

        function renderAchievements() {
            const grid = document.getElementById('achievement-grid');
            grid.innerHTML = '';

            for (const key in ACHIEVEMENTS) {
                const ach = ACHIEVEMENTS[key];
                const isUnlocked = inventory.achievements[key];

                const itemDiv = document.createElement('div');
                itemDiv.className = 'achievement-item';
                if (isUnlocked) {
                    itemDiv.classList.add('unlocked');
                }
                
                itemDiv.innerHTML = `
                    <h3>${isUnlocked ? '‚úÖ' : 'üîí'} ${ach.name}</h3>
                    <p>${ach.description}</p>
                    <p style="font-weight: bold; color: ${isUnlocked ? '#2ecc71' : 'gray'};">–ù–∞–≥—Ä–∞–¥–∞: ${ach.reward} üí∞</p>
                `;
                grid.appendChild(itemDiv);
            }
        }

        function selectDifficulty(speedValue, button) {
             currentDifficulty = speedValue;
             document.querySelectorAll('.difficulty-options button').forEach(btn => btn.classList.remove('selected'));
             button.classList.add('selected');
        }

        function selectMapMode(mode, button) {
            currentMapMode = mode;
            document.querySelectorAll('.map-options button, .event-options button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
        }
        
        function convertScoreToCoins() {
            if (stats.highScore < 3) {
                 alert('–í–∞—à –ª—É—á—à–∏–π —Å—á–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3!');
                 return;
            }
            
            const coinsToAdd = Math.floor(stats.highScore / 3);
            coins += coinsToAdd;
            stats.totalCoins += coinsToAdd;
            stats.highScore = stats.highScore % 3; // –û—Å—Ç–∞–≤—à–∏–µ—Å—è –æ—á–∫–∏ 
            
            alert(`–û–±–º–µ–Ω—è–Ω–æ: ${coinsToAdd} –º–æ–Ω–µ—Ç!`);
            saveProgress();
            renderProgression();
            renderStats();
        }

        window.onload = init; 
    </script>
</body>
</html>